name: CD

on:
  release:
    types: [published, edited]

jobs:
  build-and-push-image:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@master
        if: contains(github.ref, 'refs/tags/v')
      - name: Docker Login
        uses: Azure/docker-login@v1
        with:
          # Container registry username
          username: ${{ secrets.DOCKER_USERNAME }}
          # Container registry password
          password:  ${{ secrets.DOCKER_PASSWORD }}
          # Container registry server url
          login-server: ${{ secrets.DOCKER_REGISTRY }}
      - name: Build, tag, and push image
        env:
          REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
          REPOSITORY: yishanzhilu/tai
        run: |
          IMAGE_TAG=$(echo ${{ github.ref }} | sed -e '/refs\/tags\/v//')
          IMAGE_TAG_DATE=$(TZ='Asia/Shanghai' date -Iminutes)
          docker build -t $REGISTRY/$REPOSITORY:latest -t $REGISTRY/$REPOSITORY:$IMAGE_TAG -t $REGISTRY/$REPOSITORY:$IMAGE_TAG_DATE .
          echo "build success"
          docker push $REGISTRY/$REPOSITORY:latest
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG_DATE
